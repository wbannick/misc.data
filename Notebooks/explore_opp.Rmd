---
title: "Bay Area Stops Analysis"
output: html_document
---

<style type="text/css">

h1 {
  text-align: center;
  font-weight: bold;
  font-family: 'Helvetica Neue';
}

h2 {
 font-family: 'Helvetica Neue';
}

body{
 font-family: 'Helvetica Neue';
 font-size: 16px;
}

</style>

<br>
<br>
Discriminatory racist policing afflicts all corners of the United States, including the San Francisco Bay area. This following brief analysis is intended to help visualize this issue for people who believe that “liberal” or “progressive” Bay Area cities are immune from the institutionalized racism that governs policing. It focuses on vehicle and pedestrian stops in the three major Bay Area cities of Oakland, San Francisco and San Jose in 2014. The stop data comes from the Stanford Open Policing Project. Population estimates are drawn from the American Community Survey (ACS). This analysis is not an exhaustive exploration of the data. It is a brief overview, visualization, and discussion of some of the more glaring disparities.

```{r setup, include = F}
library(tidyverse)
library(willbprocessed)
library(here)
library(arrow)
library(coefplot)
# cleaned in scripts/clean_opp
stops <- read_feather(here("Clean_Data/opp_bay_area.feather"))
acs <- read_feather(here("Clean_Data/acs_bay_cities14.feather"))

# we're focusng on 2014 b/c its a year where all cities seem to have
# complete data!
stops <- filter(stops, year == 2014) %>%
  mutate(
    month = format(date, "%M"),
    # there are some NAs for race let's make them other...
    race5 = ifelse(is.na(race), "Other", as.character(race)) %>%
      factor(levels = levels(race)),
    # see if season has an effect...
    season = case_when(
      date < as.Date("2014-03-20") | 
        date > as.Date("2014-12-20") ~ "Winter",
      date >= as.Date("2014-03-20") & 
        date < as.Date("2014-06-21") ~ "Spring",
      date >= as.Date("2014-06-21") & 
        date < as.Date("2014-09-22") ~ "Summer",
      date >= as.Date("2014-09-22") & 
        date < as.Date("2014-12-21") ~ "Spring",
    )
    )



```


```{r format_plot_data, include=F}
#number of stops by city/race
stops_by_race <- stops %>%
  count(city, race5) %>%
  group_by(city) %>%
  mutate(
    #for analysis/more precise bars in graphs
    pct = (n/sum(n)) %>% as_percent(4),
    #for labels :)
    pct_label = (n/sum(n)) %>% as_percent(0, add_percent_sign = T),
    statistic = "Stops"
    )

# population by city/race
pop_by_race <- acs %>%
  group_by(city, race5) %>%
  summarise(n = sum(population)) %>%
  group_by(city) %>%
  mutate(
    pct = (n/sum(n)) %>% as_percent(4), 
    pct_label = (n/sum(n)) %>% as_percent(0, add_percent_sign = T),
    statistic = "Population"
  )

# join together in data for our first plot...
stops_by_pop <- stops_by_race %>%
  bind_rows(pop_by_race)

```

## Black People Stopped at Much Higher Rates

The plot below depicts the racial composition of the population of the three cities in 2014 as well as the racial composition of the recorded stops in 2014. San Francisco’s data only contains vehicular stops. Oakland seems to only contain vehicular stops as well, but there were some records that the OPP was unable to determine the stop type of. San Jose’s data includes pedestrian stops as well as vehicular.

_maybe move this to intro_
<br>
Both data sources have their flaws. American Community Surveys are conducted by the US Census Bureau and has some of the customary shortcomings in reporting one would expect from census data. The stop data comes from police data and is peppered with its own sorts of biases. In both sources it is likely that Black and Hispanic respondents may be underreported. And in one source race is self reported while in the other it is recorded by police officers. Flaws asinde an analysis of the data reveals some stark undisputable disparities.
<br>

```{r first_plot, echo=F, fig.width = 11, fig.height=6}
# catchy
pop_stop_plot <- ggplot(data = stops_by_pop) +
  # bar plot
  geom_bar(
    stat = "identity", 
    aes(x = race5, y = pct, fill = statistic),
    position = "dodge"
    ) + 
  facet_wrap( ~ city) +
  # almost did labels but i think that kinda clutters things
  # found these via color brewer
  scale_fill_manual(values = c("#1b9e77", "#d95f02")) +
  scale_y_continuous(
    # let's make em percent signs
    labels = function(x) paste0(x, "%"),
    # and break by 10
    breaks = seq(0, 60, by = 10)  
    ) +
  theme_bw() +
  theme(
    legend.position = "top",
    # I don't like legend titles haha
    legend.title = element_blank(),
    plot.title = element_text(size = 15, hjust = 0.5, face = "bold"),
    text = element_text("Helvetica Neue")
  ) +
  labs(title = "Population and Stops by Race", x = "", y = "")

pop_stop_plot

```

```{r rate_data, echo=F}
# formatting data for next plot
stop_rate <- stops_by_pop %>%
  select(-pct_label, -n) %>%
  pivot_wider(names_from = "statistic", values_from = pct) %>%
  mutate(
    rate = Stops/Population,
    rate_label = round(rate,2),
    #different color for rates over 1 because that shouldn't happen
    rate_color = ifelse(rate >1, "#ED6925FF", "#781C6DFF"),
    race = factor(race5, levels = rev(levels(race5)))
    ) %>%
  # let's drop Other just b/c its going to distort the plots
  filter(race5 != "Other")

```

Were racism not a factor in policing, one would expect the green and orange bars to be at similar levels. In particular the percent of police stops where Black people were stopped were much higher than the percent of the population of each city that were composed of Black people. This trend persists even in San Francisco and San Jose; cities with small Black populations. This means that Black people are much more likely to be stopped than Non-Black people in Bay Area Cities. 

The second plot helps reinforce these patterns. This “stop rate” is the ratio of the racial composition of all reported stops in 2014 to the racial composition of each city’s population in 2014. In a world where policing was not racially biased, the stop rate would be one in each case. This is represented by the dotted line. I did not calculate stop rate as stops per one hundred people, because some data includes vehicular data only while some also includes pedestrian data, and it is not completely clear if some cases are vehicular or pedestrian data in San Francisco. This calculation also focuses on inequalities within cities while also using a scale generalizable for easy comparisons across all three. It highlights the differences in likelihood of one racial group being stopped relative to another group and not different overall rates across cities.
<br>


```{r second_plot, echo=F, fig.width = 11, fig.height=6}

stop_rate_plot <- ggplot(data = stop_rate) +
  # basically a dot and a line
  # so the dot
  geom_point(
    aes(x = race, y = rate, color = rate_color),
    size = 3
    ) + 
  # the line
  geom_bar(
    stat = "identity",
    aes(x = race, y = rate, fill = rate_color),
    position = "dodge",
    # more of a line than a bar...
    width = 0.2
    ) +
  # think it'll look better like this...
  coord_flip() +
  facet_wrap( ~ city, ncol = 1) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "grey") +
  # found these via viridis inferno
  scale_color_manual(values = stop_rate$rate_color) +
  scale_fill_manual(values = stop_rate$rate_color) +
  # less space below 0
  scale_y_continuous(expand = c(.015,.015)) +
  # let's add a label
  geom_text(
    aes(x = race, y = rate + .1, label = rate_label),
    color = "black", fontface = "bold"
  ) +
  theme_bw() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 15, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    text = element_text("Helvetica Neue")
  ) +
  labs(
    title = "Stop Rate",
    subtitle = "Proportion of Stops / Proportion of Population",
    x = "", y = "")

stop_rate_plot

```

The stop rate plot further highlights discriminatory policing of Black Bay Area residents. In Oakland where the Black population is large, the stop rate for Black respondents is 2.32 and they are stopped at a 4.46 higher rate than white Oakland residents. While San Francisco has a much smaller Black population, the stop ratio for Black residents living in the city is 2.83, and Black residents were 3.14 times as likely to be stopped as white residents. San Jose ahs the smallest Black population of all three Bay Area cities but Black San Jose residents are stopped at the higest rate of Black people in the bay relative to all stops in the city. Their stop rate is over 3 and they are 4.78 times as likely to be stopped as White people in San Jose.

Hispanic people are stopped at higher rates than other Non-Black residents in San Jose, but not in San Francisco or Oakland. Race is difficult to measure and it is difficult to determine how a Black, Brown or white latinx individual may be coded by police in the stop data. Different stereotypes within Hispanic ethnic groups may help explain some of these differences. That said there is inconclusive proof in the data. 

In 2014, San Jose’s Hispanic population was 87% Mexican American while Oakland’s is about 70% Mexican and San Francisco’s population is about 51% Mexican. Fifty percent of San Jose’s Hispanic population was white, while about 37% of oaklands was and about 43% of San Francisco's was. Neither of these proportions alone can explain why rates between the three cities are different, but perhaps they are a part of the story. Perhaps there are more answers in how police report race data of those they stop.

Particularly curious is how much larger the proportion of stops of those whose is race is coded as other is than the proportion of those whose race is coded as other in the ACS data in San Francisco and San Jose. I did not request the source data from the OPP to see how if it could help illuminate the composition of those coded as Other. It is unclear to me, for example, if perhaps police officers listed people who’s race they were unsure about as “Other” or if those who were coded as Other belonged to unlisted racial groups. Were I dig into this data further, I would like to focus more attention to this.



```{r outcome_data, echo=F, message=F}
# let's do % of each that had each outcome
outcomes <- stops %>%
  # it seems pedestrian stops are very different in terms of these outcomes
  filter(type == "vehicular") %>%
  group_by(city, race5) %>%
  summarize(
    Arrest = mean(I(arrest_made == TRUE), na.rm = T) %>%
      as_percent(2),
    # did not end up using citations for plots
    # but asians may becited at higher rates. racist stereotypes?
    #come back to this
    Citation =  mean(I(citation_issued == TRUE), na.rm = T) %>%
      as_percent(2),
    # lot of missingness. let's skip
    #pct_warning = mean(I(warning_issued == TRUE), na.rm = T),
    #  as_percent(2)),
    # some missingness in sj
    Search = mean(I(search_conducted == TRUE), na.rm = T) %>%
      as_percent(2),
    ) %>%
  pivot_longer(
    cols = matches("^[A-Z]", ignore.case = F), 
    names_to = "outcome",
    values_to = "pct"
    ) %>%
  mutate(
    pct_label = round(pct, 1) %>% paste0("%"),
    outcome = factor(outcome, levels = c("Arrest", "Search", "Citation"))
  )

```

```{r outcome_plot_fxn, include=F}

outcome_plot <- function(df, outcome_name, y_lims, label_adj){
  df %>%
    filter(
      # we're doing a seperate plot by outcome
      outcome == outcome_name, 
      ) %>%
    ggplot() +
    # bar plot
    geom_bar(
      stat = "identity", 
      aes(x = race5, y = pct),
      fill = "#1f78b4"
    ) + 
  facet_wrap( ~ city) +
  scale_y_continuous(
    # let's make em percent signs
    labels = function(x) paste0(x, "%"),
    # and break by 10
    breaks = seq(0, 60, by = 10),
    limits = y_lims
    ) +
  # spread this out so we could do labels
  geom_text(
    aes(x = race5, y = pct + label_adj, label = pct_label),
    color = "black", fontface = "bold"
  ) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    # a little smaller
    plot.title = element_text(size = 15, hjust = 0.5, face = "bold"),
    text = element_text("Helvetica Neue")
  ) +
  labs(
    title = 
      paste0("Percent of Vehicular Stops that Resulted in ", outcome_name),
    x = "",
    y = "")
}

```

## Black and Hispanic People More Likely To Be Searched and Arrested

Next, I turn to the outcome of stops. For this section, I focus on vehicular stops, because stop rates for pedestrian stops were significantly different. This section focuses on what happens to motorists once they are stopped, and finds that Black and Hispanic motorists are more likely to be both searched and arrested than are Asian or White motorists.
<br>

```{r third_plots, echo=F, fig.width = 11, fig.height=4}
# plots!
outcome_plot(outcomes, "Search", y_lims = c(0,35), label_adj = 3)
outcome_plot(outcomes, "Arrest", y_lims = c(0,10), label_adj = 1)

```

In Oakland and San Francisco, Black respondents are much more likely to be searched and arrested than Hispanic respondents, but in San Jose the rates are similar. This again speaks to more discriminatory policing against Hispanic people in San Jose than in Oakland or San Francisco. Yet, across the Bay it is clear that discrimination not only happens in deciding who to stop, but how stops are conducted. 

Search and arrest rates are also generally higher in Oakland and San Jose than San Francisco. Perhaps policy officers feel more unsafe in areas with higher populations of Black and Brown people and are more likely to search and arrest people of any race in these areas than they would in other areas. As for much of this analysis neighborhood data would be helpful here.

I have seen others argue that an evaluation of whether or not a stop is discriminatory should take into account. 


```{r models, include=F}
# basically a bunch of dummies to save time re-labeling plots lol
stops_model_data <- select(stops, city, type, arrest_made, search_conducted) %>%
  bind_cols(willbprocessed::factor_to_dummies(stops$race5)) %>%
  bind_cols(willbprocessed::factor_to_dummies(factor(stops$gender))) %>%
  bind_cols(willbprocessed::factor_to_dummies(factor(stops$season))) %>%
  bind_cols(willbprocessed::factor_to_dummies(factor(stops$city))) %>%
  # SJ missing gender data and pedestrian data only in SJ
  filter(city %in% c("Oakland", "San Francisco"), type == "vehicular")

# Originaly had models by city but changed it to one model for all vehicle
# stops in Oak/SF Ccuz pedestrian stops seemed pretty different on arrest +
# search and sj had no gender data
out_models <- map(c("search_conducted", "arrest_made"), function(var_name){
  glm(
    # change to black, whit hisp + male + summer + winter
    stops_model_data[[var_name]] ~ 
      Black + Hispanic + White + Male + Oakland + Summer + Winter,
    data = stops_model_data,
    family = quasibinomial(link = "logit")
    )
})
names(out_models) <- c("Search", "Arrest")

```


```{r coef_plot, echo=F, fig.width = 11, fig.height=5, message=F}

coefplot::multiplot(out_models,
                    innerCI = 1, 
                    outerCI = 2,
                    sort = "magnitude", 
                    legend.reverse = T,
                    lwdOuter = 1,
                    lwdInner = 2,
                    single = F,
                    zeroColor = "black",
                    zeroLWD = 1.5,
                    zeroType = 2,
                    xlab = "",
                    ylab = "",
                    title =  
                      "Coefficients of Vehicular Stop Models"
                    ) +
  scale_color_manual(values = c("#1f78b4", "#1f78b4")) +
  scale_x_continuous(
    breaks = seq(-6, 3, by = 1) 
  ) +
  xlim(-6,3) +
  theme_bw() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 15, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    text = element_text("Helvetica Neue")
    ) +
  labs(subtitle = "Oakland and San Francisco")

```

